<!DOCTYPE html>
<html>
    <head>
        <title>Audio Visualizer</title>
        <script type="text/javascript">
let cvElem, dbElem, cvCtx, dbCtx;
let width, height, radius;
window.addEventListener("load", () => {
    // Canvas, double buffer elements and contexts
    cvElem = document.getElementById("viz");
    cvCtx = cvElem.getContext("2d");
    dbElem = document.getElementById("vizdb");
    dbCtx = dbElem.getContext("2d");

    // Window dimensions
    width = document.body.offsetWidth;
    height = document.body.offsetHeight;
    radius = Math.min(width, height) * 0.4;

    // Set the canvas to the window dimensions
    cvElem.width = width;
    cvElem.height = height;
    dbElem.width = width;
    dbElem.height = height;

    // Start the animation loop
    frame();
});

function frame() {
    requestAnimationFrame(frame);

    setTransform();
    drawVisualization();
    drawDB();
    restoreTransform();
}

function setTransform() {
    const ctx = dbCtx;
    ctx.clearRect(0, 0, width, height);
    ctx.save();
    ctx.translate(width / 2, height / 2);
}

function restoreTransform() {
    const ctx = dbCtx;
    ctx.restore();
}

function drawVisualization() {
    // PLACEHOLDER VISUALIZATION
    const ctx = dbCtx;
    const offset = Date.now() * 0.004;
    const segments = 10;

    ctx.strokeStyle = "blue";
    ctx.lineWidth = 3;
    ctx.beginPath();
    [0.9, 1.1].forEach(side => {
        for (let i = 0; i <= segments; i++) {
            const angle0 = (i + 0.00) / segments * 2.0 * Math.PI + offset;
            const angle1 = (i + 0.25) / segments * 2.0 * Math.PI + offset;
            const angle2 = (i + 0.50) / segments * 2.0 * Math.PI + offset;
            const angle3 = (i + 0.85) / segments * 2.0 * Math.PI + offset;
            const angle4 = (i + 1.00) / segments * 2.0 * Math.PI + offset;
            if (i === 0) {
                ctx.moveTo(radius * Math.cos(angle0), radius * Math.sin(angle0));
            }
            if (i === 1) {
                const cpradius = radius / Math.cos(0.25 / segments * 2.0 * Math.PI);
                const pkradius = radius * side;
                ctx.bezierCurveTo(
                    cpradius * Math.cos(angle1), cpradius * Math.sin(angle1),
                    pkradius * Math.cos(angle1), pkradius * Math.sin(angle1),
                    pkradius * Math.cos(angle2), pkradius * Math.sin(angle2)
                );
                ctx.bezierCurveTo(
                    pkradius * Math.cos(angle3), pkradius * Math.sin(angle3),
                    cpradius * Math.cos(angle3), cpradius * Math.sin(angle3),
                    radius * Math.cos(angle4),   radius * Math.sin(angle4)
                );
            }
            else {
                const cpradius = radius / Math.cos(0.5 / segments * 2.0 * Math.PI);
                ctx.quadraticCurveTo(
                    cpradius * Math.cos(angle2), cpradius * Math.sin(angle2),
                    radius * Math.cos(angle4), radius * Math.sin(angle4)
                );
            }
        }
    });
    ctx.stroke();
}

function drawDB() {
    cvCtx.drawImage(dbElem, 0, 0);
}

window.addEventListener("keydown", e => {
    if (e.keyCode === 27) {
        window.close();
    }
});
        </script>
        <style type="text/css">
body {
    margin: 0;
    padding: 0;
    overflow: hidden;
    -webkit-app-region: drag;
}

canvas {
    width: 100%;
    height: 100%;
}

#vizdb {
    top: -150%;
}
        </style>
    </head>
    <body>
        <canvas id="vizdb"></canvas>
        <canvas id="viz"></canvas>
    </body>
</html>